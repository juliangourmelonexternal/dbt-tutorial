name: DBT CI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v2

    - name: Run a one-line script
      run: echo Hello, world!

    - name: Run a multi-line script
      run: |
        echo Add other tasks to build, test, and deploy your project.
        echo See https://aka.ms/yaml

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip python3-venv
        python3 -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install dbt pre-commit

    - name: Run pre-commit checks
      run: |
        source venv/bin/activate
        pre-commit install
        pre-commit run --all-files

    - name: Run dbt tests
      run: |
        source venv/bin/activate
        cd ./dbt_tutorial
        dbt deps
        dbt test
